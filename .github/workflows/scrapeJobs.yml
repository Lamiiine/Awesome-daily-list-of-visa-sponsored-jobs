name: Scrape latest data

on:
  push:
  workflow_dispatch:
  schedule:
    - cron:  '6 12 * * *'

jobs:
  scheduled:
    runs-on: ubuntu-latest
    steps:
    - name: Check out this repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Fetch latest data
      run: |-
        curl https://relocate-with-us.github.io/db.json | jq '.[] | [.company, .position, .location, .description]' -c > jobList.txt
    - name: Install tabulate
      run: |
        pip install tabulate
    - name: Generate table
      run: |
        echo "Company | Position | Location | Description" > table.md
        echo "--- | --- | --- | ---" >> table.md
        cat jobList.txt | python -c "import json,sys; from tabulate import tabulate; print(tabulate(json.load(sys.stdin), headers=['Company', 'Position', 'Location', 'Description'], tablefmt='pipe'))" >> table.md
    - name: Update README
      run: |
        sed -i '/<!-- start job list -->/,/<!-- end job list -->/c\<!-- start job list -->\n\n'"$(cat table.md)"'\n\n<!-- end job list -->' README.md
    - name: Commit and push if it changed
      run: |-
        git config user.name "Automated"
        git config user.email "actions@users.noreply.github.com"
        git add README.md
        timestamp=$(date -u)
        git commit -m "Update job list: ${timestamp}" || exit 0
        git push
